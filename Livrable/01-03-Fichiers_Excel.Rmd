---
title: "Fichiers Excel"
author: "NK & SG"
date: "octobre 2018"
output:
  html_document:
    theme: united
    toc: true
    toc_depth: 4
    toc_float: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Problématique

Manipuler des fichiers "tableurs" dans R, en particulier celui de Microsoft, Excel. L'objectif est de lire les données d'un fichier Excel dans une structure de données R, ou l'inverse, exporter des données R dans Excel

## Solutions retenues

### Format **xlsx**

Le package `openxlsx` offre un ensemble de fonctions simples et efficaces permettant de lire et écrire des données en Excel au format **xlsx** compatible avec le tableur `calc`. Il gère correctement les formats de données notamment les dates, les nombres très proches de zéro et les formats monétaires. Ce package ne permet pas de lire et écrire au format **xls**.

### Format **xls**

La fonction `read_xls` du package `readxl` développé par Hadley Wickham permet de lire des fichiers au format **xls**. 

> Les packages `openxlsx` et `readxl` ne présente aucune dépendance avec une installation java sur poste. 

## Particularité de syntaxe

Aucune. 

## Exemples

### Table d'entrainement

Cette table contient divers formats de données tels que les dates, les opérateurs logiques, les données monétaires, des nombres négatifs, des liens internet, des pourcentages et des chiffres très petits. 

```{r}
library(openxlsx)

df <- data.frame("Date" = Sys.Date()-0:4,
                 "Logical" = c(TRUE, FALSE, TRUE, TRUE, FALSE),
                 "Currency" = paste("$",-2:2),
                 "Accounting" = -2:2,
                 "hLink" = "https://CRAN.R-project.org/",
                 "Percentage" = seq(-1, 1, length.out=5),
                 "TinyNumber" = runif(5) / 1E9, stringsAsFactors = FALSE)
```

### Écriture au format **xlsx**

```{r}
write.xlsx(df, file = "writeXLSX1.xlsx")
```

### Lecture au format **xlsx**

```{r}
df.excel <- read.xlsx(xlsxFile = "writeXLSX1.xlsx",detectDates = TRUE)
head(df.excel,n = 2)
```


### Lecture au format **xls**

Le fichier des populations 2013 des quartiers de la politique de la ville est disponible sur le site insee.fr à l'adresse suivante : <https://insee.fr/fr/statistiques/fichier/2500431/pop_qp_2013.xls>


**Étape 1** : téléchargement et enregistrement du fichier sur poste
```{r}
target = "https://insee.fr/fr/statistiques/fichier/2500431/pop_qp_2013.xls"
destination = 'Qpv_pop.xls'
download.file(url = target, destfile = destination, mode='wb')
```

**Étape 2** : lecture du fichier
```{r}
library(readxl)
pop_qpv13<- read_xls(path = destination,skip = 8)
```

> L'option `skip` permet de ne pas lire les 8 premières lignes du fichier.

**Étape 3** : transformation des données
```{r,message=FALSE,warning=FALSE}
library(tidyverse)
pop_qpv13 <- pop_qpv13 %>% 
  filter(reg == "02") %>% 
  select(qp,nom_qp,liste_des_communes,population_municipale_2013)

head(pop_qpv13)
```


### Ecriture d'un rapport complexe

La création d'un classeur comportant plusieurs feuilles, plusieurs tableaux, des titres et des graphiques est possible. Pour cela, il faut créer manuellement une série d'objets interagissant les uns avec les autres. 

La syntaxe est présentée dans l'exemple suivant : 

**Étape 1** : Création du classeur

```{r}
wb <- createWorkbook()
```

**(Étape facultative)** : création d'un style de mis en forme pour les titres
```{r}
titre.style <- createStyle(fontSize=14, textDecoration=c("bold", "italic"))
```


**Étape 2** : Ajout d'une feuille au classeur qui contient deux tableaux de données dont l'un mis en forme. 

```{r}
addWorksheet(wb, "Tableau")
```


Ajout d'un titre mis en forme
```{r}
writeData(wb,sheet = "Tableau", x = "Exemple de tableaux de données contenant différents types de variables", startRow = 1)
addStyle(wb, "Tableau", style = titre.style, rows= 1,cols = 1)
```


Ajout de deux tableaux de données dans la feuille **Tableau**. Les délimitations de colonnes sont tracées pour le second tableau.

```{r}
writeData(wb, 1, df, startRow = 2, startCol = 2)
writeData(wb, 1, mtcars, startRow = 9, startCol = 2, borders ="all")
```

**Étape 3** : Ajout d'une feuille supplémentaire contenant un tableau mis en forme

```{r}
addWorksheet(wb, "Tableau mis en forme")
```

Création d'un style de mise en forme pour le tableau

```{r}
hs1 <- createStyle(fgFill = "#4F81BD", halign = "CENTER", textDecoration = "Bold",
                   border = "Bottom", fontColour = "white")
```

Ajout du tableau mis en forme dans la feuille

```{r}
writeData(wb, sheet = "Tableau mis en forme", iris, startRow = 16, startCol = 10, headerStyle = hs1,
          borders = "rows", borderStyle = "medium")
```

**Étape 4** : Ajout de la feuille graphique

```{r}
addWorksheet(wb,"Graphique")
```

Création d'un graphique 

```{r,message=FALSE,warning=FALSE}
library(ggformula)
figure <- pop_qpv13 %>%
  gf_barh(str_wrap(nom_qp,10) ~ population_municipale_2013,stat = "identity",fill = ~liste_des_communes ,
         alpha = 0.80) %>%
  gf_labs(x = "" , y = "Quartiers prioritaires",
          title = str_wrap("Population municipale martiniquaise des quartiers la politique de la ville en 2013",40),
          fill = "Communes",
          caption = "Source : Recensement de la population 2013"
          )

plot(figure)
```

> La fonction `str_wrap` force le retour à la ligne à partir d'un certain nombre de caractères.

Insertion du graphique dans la feuille **Graphique**.

```{r}
insertPlot(wb, sheet = "Graphique", xy = c("J", 3))
```

Ouverture d'un version temporaire du classeur. 

```{r,eval=FALSE}
openXL(wb)
```

Enregistrement du classeur

```{r}
saveWorkbook(wb, "Exemple_tableur_complexe.xlsx", overwrite = TRUE)
```


## Solutions viables non retenues

Les packages `xlsx` et `XLConnect` sont des bonnes alternatives au package `openxlsx`. Néanmoins, ils sont dépendants à une installation java sur poste ce qui peut les rendre inutilisables sous certains systèmes.  

## Solutions à ne pas utiliser

Le package `writexl` est efficace pour la lecture et l'écriture de fichiers. Cependant, il dispose de peu de fonctionnalités et ne gère pas correctement certains formats de données. D'autres packages tels que `excel.link`, `RODBC`, `RJDBC`, `dataframes2xls`, `WriteXLS`, `RExcel`, `xlsReadWrite` et `gdata` existent mais sont utilisés de manière marginale par la communauté R. 

## Niveau d'intégration à l'USSR

### Développements préconisés

Aucun.

### Points de vigilance

Ce package ne permet pas de lire et d'écrire des fichiers au format **xls**.


## Intégration au dispositif de formation

La question est abordée dans la formation "Prise en main rapide de données sous R", lors de la séquence 9 ("formats de fichiers d'échange").

## Pour aller plus loin

Deux vignettes :

* Exemples simples : <https://cran.r-project.org/web/packages/openxlsx/vignettes/Introduction.pdf>
* Exemples complexes : <https://cran.r-project.org/web/packages/openxlsx/vignettes/formatting.pdf>

